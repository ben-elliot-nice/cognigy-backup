# Cognigy Backup Template

Automated backup system for Cognigy.AI projects using GitHub Actions and orphan branch snapshots for storage-efficient versioning.

## üéØ Quick Start

### 1. Create New Backup Repository

1. Click **"Use this template"** ‚Üí **"Create a new repository"**
2. Name it: `cognigy-backup-{your-project-name}`
3. Set to **Private**
4. Click **"Create repository"**

### 2. Configure Your Backup

```bash
# Clone your new repository
git clone git@github.com:{your-username}/cognigy-backup-{project-name}.git
cd cognigy-backup-{project-name}

# Run interactive setup
./scripts/setup-interactive.sh

# Commit configuration
git add .
git commit -m "Configure backup [skip-setup]"
git push
```

### 3. Add GitHub Secrets

Go to **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions** and add:

- `COGNIGY_BASE_URL` - Your Cognigy API endpoint (e.g., `https://api-app.cognigy.ai`)
- `COGNIGY_API_KEY` - Your Cognigy API key
- `COGNIGY_AGENT_ID` - Your Cognigy agent/project ID

### 4. Enable Workflows

Go to **Actions** tab ‚Üí Enable workflows ‚Üí Manually trigger first backup

---

## üìö What This Does

### Backup Strategy

**Storage-Optimized Snapshot Tiers:**
- **Hourly** (default: every 30 min) - Last 6 snapshots ‚Üí 3 hours of history
- **Daily** (every 6 hours) - Last 7 snapshots ‚Üí 1 week of history
- **Weekly** (every Sunday) - Last 4 snapshots ‚Üí 1 month of history
- **Monthly** (GitHub Releases) - Last 12 releases ‚Üí 1 year of history

**Total Storage:** ~145 MB per project (fixed, doesn't grow over time)

### How It Works

1. **Backup workflow** runs on schedule (default: every 30 minutes)
2. Pulls latest project state from Cognigy using `cognigy clone`
3. Detects changes (only creates snapshot if project changed)
4. Creates orphan commit on `snapshot/hourly` branch
5. **Promotion workflow** copies snapshots between tiers (hourly ‚Üí daily ‚Üí weekly ‚Üí monthly)
6. **Cleanup workflow** enforces retention policy (removes old snapshots)

### Branch Structure

```
main                    # Workflows + config (no Cognigy data)
snapshot/hourly         # Last 6 half-hour snapshots
snapshot/daily          # Last 7 daily snapshots
snapshot/weekly         # Last 4 weekly snapshots
releases/               # 12 monthly GitHub Releases
```

---

## üîß Configuration

All settings are in `config.json` (generated by setup script).

### Retention Policy

Customize snapshot intervals and retention counts:

```json
{
  "retention": {
    "hourly": {
      "enabled": true,
      "count": 6,
      "intervalMinutes": 30
    },
    "daily": {
      "enabled": true,
      "count": 7,
      "intervalHours": 6
    }
  }
}
```

See `config.json.example` for all options.

---

## üîÑ Restoring from Backup

### Quick Restore (via GitHub Actions)

1. Go to **Actions** ‚Üí **Restore Backup**
2. Click **Run workflow**
3. Select snapshot tier and commit
4. Enable dry-run to preview changes
5. Approve restore (if using GitHub Environments)

### Manual Restore

```bash
# Checkout specific snapshot
git checkout snapshot/daily

# Verify backup contents
ls agent/

# Restore to Cognigy (requires local config)
cognigy restore -y
```

See [docs/RESTORE-GUIDE.md](docs/RESTORE-GUIDE.md) for detailed instructions.

---

## üìñ Documentation

- **[PROJECT.md](docs/PROJECT.md)** - Complete project plan and architecture decisions
- **[SETUP-GUIDE.md](docs/SETUP-GUIDE.md)** - Detailed setup walkthrough
- **[RESTORE-GUIDE.md](docs/RESTORE-GUIDE.md)** - How to restore backups
- **[ARCHITECTURE.md](docs/ARCHITECTURE.md)** - Technical implementation details

---

## üõ†Ô∏è Tools Used

- **[Cognigy CLI](https://www.npmjs.com/package/@cognigy/cognigy-cli)** - Official Cognigy command-line interface
- **GitHub Actions** - Workflow automation
- **Orphan Branches** - Storage-efficient snapshot versioning
- **GitHub Releases** - Long-term monthly archives

---

## üîí Security

- ‚úÖ Credentials stored in GitHub Secrets (never committed)
- ‚úÖ Backup repositories should be **private**
- ‚úÖ Restore workflow requires manual approval (configurable)
- ‚úÖ All operations logged in GitHub Actions

---

## üìä Monitoring

### Check Backup Status

```bash
# View recent workflow runs
gh run list --limit 10

# Check specific workflow
gh run view <run-id> --log

# See all snapshots
git branch -r
```

### Storage Usage

```bash
# Check repository size
gh api repos/{owner}/{repo} | jq '.size'
```

---

## üÜò Troubleshooting

### Common Issues

**Backup workflow fails with 401 Unauthorized**
- Verify `COGNIGY_API_KEY` is correct and not expired
- Check `COGNIGY_BASE_URL` matches your environment

**No snapshots created despite workflow running**
- Check workflow logs for "No changes detected"
- Verify Cognigy project has actual data
- Ensure agent ID is correct

**Storage growing unexpectedly**
- Verify cleanup workflow is running
- Check retention policy in `config.json`
- Run `git gc --prune=now --aggressive` locally

See [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md) for more troubleshooting.

---

## üìù License

Internal use only. Contains proprietary Cognigy project data.

---

## ü§ù Contributing

This is a template repository. To improve the template:

1. Fork this repo
2. Make changes
3. Test with a real Cognigy project
4. Submit PR with description

---

**Need help?** Check the [detailed documentation](docs/) or open an issue.
